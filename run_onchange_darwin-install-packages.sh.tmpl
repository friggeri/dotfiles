{{ if eq .chezmoi.os "darwin" -}}

#!/bin/bash
# Hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

set -eufo pipefail

echo "ğŸº Setting up Homebrew packages..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Update Homebrew
echo "Updating Homebrew..."
brew update

{{ if .packages.darwin.taps -}}
# Install taps
echo "ğŸ“¦ Installing Homebrew taps..."
{{ range .packages.darwin.taps -}}
brew tap "{{ . }}" || true
{{ end -}}
{{ end -}}

{{ if or .packages.darwin.brews .packages.darwin.casks -}}
# Install formulae and casks
echo "ğŸ“¦ Installing Homebrew packages..."
brew bundle --verbose --file=/dev/stdin <<EOF
{{ range .packages.darwin.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.darwin.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF
{{ end -}}

{{ if .packages.darwin.mas -}}
# Install Mac App Store apps
if ! command -v mas &> /dev/null; then
    echo "Installing mas CLI..."
    brew install mas
fi

echo "ğŸ›ï¸ Installing Mac App Store apps..."
{{ range .packages.darwin.mas -}}
mas install {{ .id }} || echo "Failed to install {{ .name }} ({{ .id }})"
{{ end -}}
{{ end -}}

echo "âœ… Package installation complete!"

{{- end }}