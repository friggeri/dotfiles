{{ if eq .chezmoi.os "darwin" -}}

#!/bin/bash
# Hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

set -eufo pipefail

echo "üç∫ Setting up Homebrew packages..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Update Homebrew
echo "Updating Homebrew..."
brew update

{{ $commonTaps := .packages.darwin.common.taps | default list -}}
{{ $machineTaps := index .packages.darwin .machineType "taps" | default list -}}
{{ $allTaps := concat $commonTaps $machineTaps | uniq -}}
{{ if $allTaps -}}
# Install taps
echo "üì¶ Installing Homebrew taps..."
{{ range $allTaps -}}
brew tap "{{ . }}" || true
{{ end -}}
{{ end -}}

{{ $commonBrews := .packages.darwin.common.brews | default list -}}
{{ $machineBrews := index .packages.darwin .machineType "brews" | default list -}}
{{ $allBrews := concat $commonBrews $machineBrews | uniq -}}
{{ $commonCasks := .packages.darwin.common.casks | default list -}}
{{ $machineCasks := index .packages.darwin .machineType "casks" | default list -}}
{{ $allCasks := concat $commonCasks $machineCasks | uniq -}}
{{ if or $allBrews $allCasks -}}
# Install formulae and casks
echo "üì¶ Installing Homebrew packages ({{ .machineType }} machine)..."
brew bundle --verbose --file=/dev/stdin <<EOF
{{ range $allBrews -}}
brew {{ . | quote }}
{{ end -}}
{{ range $allCasks -}}
cask {{ . | quote }}
{{ end -}}
EOF
{{ end -}}

{{ $commonMas := .packages.darwin.common.mas | default list -}}
{{ $machineMas := index .packages.darwin .machineType "mas" | default list -}}
{{ $allMas := concat $commonMas $machineMas | uniq -}}
{{ if $allMas -}}
# Install Mac App Store apps
if ! command -v mas &> /dev/null; then
    echo "Installing mas CLI..."
    brew install mas
fi

echo "üõçÔ∏è Installing Mac App Store apps ({{ .machineType }} machine)..."
{{ range $allMas -}}
mas install {{ .id }} || echo "Failed to install {{ .name }} ({{ .id }})"
{{ end -}}
{{ end -}}

echo "‚úÖ Package installation complete!"

{{- end }}